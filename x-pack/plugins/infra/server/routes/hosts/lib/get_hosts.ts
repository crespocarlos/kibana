/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License
 * 2.0; you may not use this file except in compliance with the Elastic License
 * 2.0.
 */

import { GetHostsResponsePayload } from '../../../../common/http_api/hosts';
import { getFilteredHosts } from './get_filtered_hosts';
import { mapToApiResponse } from './mapper';
import { hasFilters } from './utils';
import { GetHostsArgs } from './types';
import { getAllHosts } from './get_all_hosts';
import { COMPOSITE_KEY } from './constants';

export const getHosts = async (args: GetHostsArgs): Promise<GetHostsResponsePayload> => {
  const runFilterQuery = hasFilters(args.params.query);
  // filter first to prevent filter clauses from impacting the metrics aggregations.
  const hostNamesShortList = runFilterQuery ? await getFilteredHostNames(args) : [];
  if (runFilterQuery && hostNamesShortList.length === 0) {
    return {
      hosts: [],
    };
  }

  const result = await getAllHosts(args, hostNamesShortList);

  return mapToApiResponse(args.params, result?.hosts.buckets);
};

const getFilteredHostNames = async (args: GetHostsArgs) => {
  const filteredHosts = await getFilteredHosts(args);

  const { hosts } = filteredHosts ?? {};
  return hosts?.buckets.map((p) => p.key[COMPOSITE_KEY]) ?? [];
};
